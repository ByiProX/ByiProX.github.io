---
title: DHCP续租过程
date: 2018-09-25 10:27:21
tags:
  - 网络
categories:
  - 网络
---

计算机网络发展的早些时候，当一台设备想要在网络上通信的时候，它需要被手动分配一个地址。随着网络的发展，手动方式变得烦琐，为了解决这个问题，`BOOTY协议(Bootstrap Protocol)`被创建出来给链接到网络的设备自动分配地址。BOOTY协议后来被更加复杂的`动态主机配置协议DHCP(Dynamic Host Configuration Protocol)`取代。

DHCP用的端号是`UDP67`和`UDP68`，这两个端口是正常的DHCP服务端口，你可以理解为一个发送，一个接收。`客户端向68端口（bootps）广播请求配置，服务器向67端口（bootpc）广播回应请求`。

#### DHCP续租过程


| DHCP客户端   | DORA过程  | DHCP服务器 |
| :-----:     | :-----------: |:------:|
|      →     | 发现Discover  → |   →    |
|      ←     | 提供Offer    ←  |     ←    |
|      →     | 请求Request   → |    →     |
|       ←    | 确认Acknowledgement  ←|     ←    |

<!-- more -->

##### 1.发现数据包
第一个数据包从`0.0.0.0`的`68端口`发往`255.255.255.255`的`67端口`。客户端使用0.0.0.0，是因为目前还没有IP地址。数据包发往255.255.255.255，是因为这是一个独立于网络的广播地址，从而能够确保这个数据包会被发往网络上的每一台设备。因为这台设备并不知道DHCP服务器的地址，所有它的第一个数据包是为了寻找正在监听的DHCP服务器。

DHCP客户端对请求响应速度要求很高。由于DHCP有其内置的保证可靠性的方法，也就意味着UDP是最合适的协议。

数据包中包括了所请求的IP地址，表示客户端希望得到的IP的地址，通常是之前用过的IP地址。


##### 2.提供数据包

这个数据包包含了和前一个数据包相同的事务ID，该ID告诉我们这个响应与原先的请求相对应。该数据包由DHCP服务器发出，用于向客户端提供服务。它提供的信息，包括自己的IP，以及给客户端提供的地址等。

##### 3.请求数据包

当客户端收到DHCP服务器提供的数据包之后，它将以一个DHCP请求数据包作为接收确认。该数据包仍然从IP为0.0.0.0的地址发出，因为我们还没有完成获取IP地址的过程。目的地址为255.255.255.255.


值得注意的是在选项域(Option)中所请求的IP地址不在为空,而是上一个提供数据包中提供的客户端IP。DHCP服务器标识域野包含了IP地址。

##### 4.确认数据包

该过程是DHCP在确认数据包中给客户端发送其所请求的IP地址，并在数据库中记录相关信息。此时客户端就有了一个IP地址，并且可以用它在网络上通信。


#### DHCP租约内续租
当DHCP给一个客户端分配了一个IP时，它同时给客户端定下了一个租约。也就是说客户端只能在有限的时间内使用该IP地址，否则必须续租。

前面介绍的DORA过程出现在客户端第一次获取IP地址或者其租约时间已经过期的情况下。在这两种情况下们该设备都被视为违约过期。

当一个拥有IP地址的客户端在租约期内重新启动，他必须进行一次精简版的DORA过程来重新认领它的IP地址，该过程被称为租约内续租。

在租约内续租时，发现和提供数据包就变得没有必要了。考虑到其与租约过期时的DORA过程类似，可以发现在租约期内续租并不需要那么做，而只是完成请求和确认两个步骤就好了。
