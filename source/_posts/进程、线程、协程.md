---
title: 进程、线程、协程
date: 2018-03-04 01:20:18
tags:
  - 操作系统
categories:
  - 操作系统
  - 多任务处理
---

## 进程

电脑里运行的应用程序，都是进程，假设我们用的电脑是单核的，CPU同时只能执行一个进程。当程序处于I/O阻塞的时候，CPU如果和程序一起等待，那就太浪费了，CPU会去执行其他的程序，此时就涉及到切换，切换前要保存上一个程序运行的状态，才能恢复，所以就需要有个东西来记录这个东西，就可以引出进程的概念了。

进程就是`一个程序在一个数据集上的一次动态执行过程`。进程是一个动态概念，是竟争计算机系统资源的基本单位。进程由`程序`，`数据集`，`进程控制块`三部分组成。`程序`用来描述进程哪些功能以及如何完成；`数据集`是程序执行过程中所使用的资源；`进程控制块`用来保存程序运行的状态.

`进程是系统进行资源分配和调度的一个独立单位`。每个进程都有自己的独立内存空间，不同进程通过进程间通信来通信。由于进程比较重量，占据独立的内存，所以上下文进程间的切换开销（栈、寄存器、虚拟内存、文件句柄等）比较大，但相对比较稳定安全。

<!-- more -->
## 线程

在网络或多用户环境下，一个服务器通常需要接收大量且不确定数量用户的并发请求，为每一个请求都创建一个进程显然是行不通的，——无论是从系统资源开销方面或是响应用户请求的效率方面来看。因此，操作系统中`线程`的概念便被引进了。线程，是进程的一部分，`一个没有线程的进程可以被看作是单线程的`。线程有时又被称为`轻权进程`或`轻量级进程`，是一个基本的cpu执行单元，也是程序执行过程中的最小单元。一个进程最少也会有一个主线程，在主线程中通过threading模块，再开子线程。

线程自己基本上不拥有系统资源,只拥有一点在运行中必不可少的资源(如程序计数器,一组寄存器和栈),但是它可与同属一个进程的其他的线程共享进程所拥有的全部资源。线程间通信主要通过共享内存，上下文切换很快，资源开销较少，但相比进程不够稳定容易丢失数据。

**进程拥有一个完整的虚拟地址空间，不依赖于线程而独立存在；反之，线程是进程的一部分，没有自己的地址空间，与进程内的其他线程一起共享分配给该进程的所有资源。**

**进程的状态有就绪，运行，等待三个状态；线程的状态有新建-就绪-（阻塞）-运行–死亡四个基本状态**

线程全局锁GIL(Global Interpreter Lock),即Python为了保证线程安全而采取的`独立线程运行的限制`,说白了就是一个核只能在同一时间运行一个线程.对于io密集型任务，python的多线程起到作用，但对于cpu密集型任务，python的多线程几乎占不到任何优势，还有可能因为争夺资源而变慢。

## 进程、线程的关系

1. 一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程
2. 资源分配给进程，进程是程序的主体，同一进程的所有线程共享该进程的所有资源
3. CPU分配给线程，即真正在CPU上运行的是线程
4. 线程是最小的执行单元，进程是最小的资源管理单元

## 协程Coroutine

协程是一种用户态的轻量级线程，协程的调度完全由用户控制。协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈则基本没有内核切换的开销，可以不加锁的访问全局变量，所以上下文的切换非常快。

`进程`拥有自己独立的堆和栈，既不共享堆，亦不共享栈，`进程由操作系统调度`。
`线程`拥有自己独立的栈和共享的堆，共享堆，不共享栈，线程亦由操作系统调度(标准线程是的)。
协程和线程一样共享堆，不共享栈，协程由程序员在协程的代码里显示调度。
进程和其他两个的区别还是很明显的。
`协程和线程的区别是`：协程避免了无意义的调度，由此可以提高性能，但也因此，程序员必须自己承担调度的责任，同时，`协程也失去了标准线程使用多CPU的能力。`

举个例子：
假设有一个操作系统，是单核的，系统上没有其他的程序需要运行，有两个线程 A 和 B ，A 和 B 在单独运行时都需要 10 秒来完成自己的任务，而且任务都是运算操作，A B 之间也没有竞争和共享数据的问题。现在 A B 两个线程并行，操作系统会不停的在 A B 两个线程之间切换，达到一种伪并行的效果，假设切换的频率是每秒一次，切换的成本是 0.1 秒(主要是栈切换)，总共需要 20 + 19 * 0.1 = 21.9 秒。如果使用协程的方式，可以先运行协程 A ，A 结束的时候让位给协程 B ，只发生一次切换，总时间是 20 + 1 * 0.1 = 20.1 秒。如果系统是双核的，而且线程是标准线程，那么 A B 两个线程就可以真并行，总时间只需要 10 秒，而协程的方案仍然需要 20.1 秒。

人们通常将协程和子程序（函数）比较着理解。
子程序调用总是一个入口，一次返回，一旦退出即完成了子程序的执行。
协程的起始处是第一个入口点，在协程里，返回点之后是接下来的入口点。在python中，协程可以通过yield来调用其它协程。通过yield方式转移执行权的协程之间不是调用者与被调用者的关系，而是彼此对称、平等的，通过相互协作共同完成任务。其运行的大致流程如下：

1. 第一步，协程A开始执行。
2. 第二步，协程A执行到一半，进入暂停，通过yield命令将执行权转移到协程B。
3. 第三步，（一段时间后）协程B交还执行权。
4. 第四步，协程A恢复执行。

协程的特点在于是`一个线程执行`，与多线程相比，其优势体现在：

协程的执行效率非常高。因为子程序切换不是线程切换，而是由程序自身控制，因此，`没有线程切换的开销`，和多线程比，线程数量越多，协程的性能优势就越明显。
协程不需要多线程的锁机制。在协程中控制共享资源不加锁，只需要判断状态就好了。
Tips:利用多核CPU最简单的方法是多进程+协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。

## 总结

### 进程与线程比较

线程是指进程内的一个执行单元,也是进程内的可调度实体。线程与进程的区别:
1. 地址空间:线程是进程内的一个执行单元，进程内至少有一个线程，它们共享进程的地址空间，而进程有自己独立的地址空间
2. 资源拥有:进程是资源分配和拥有的单位,同一个进程内的线程共享进程的资源
3. 线程是处理器调度的基本单位,但进程不是
4. 二者均可并发执行

5. 每个独立的线程有一个程序运行的入口、顺序执行序列和程序的出口，但是线程不能够独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制

### 协程与线程进行比较

1. 一个线程可以多个协程，一个进程也可以单独拥有多个协程，这样python中则能使用多核CPU。
2. 线程进程都是同步机制，而协程则是异步
3. 协程能保留上一次调用时的状态，每次过程重入时，就相当于进入上一次调用的状态
